<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>معرض السيارات الجديدة | أحدث الموديلات</title>
  <meta name="description" content="معرض الغانم للسيارات الجديدة - تصفح أحدث السيارات الجديدة، اختر الأنسب لك، وارسِل طلبك فوراً على واتساب." />
  <meta name="theme-color" content="#25D366" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --wa: #16a34a;
      --primary: #374151;
      --primary-light: #6b7280;
      --primary-dark: #1f2937;
      --secondary: #64748b;
      --accent: #059669;
      --dark: #0f172a;
      --muted: #64748b;
      --gradient-start: #374151;
      --gradient-end: #1f2937;
      --card-bg: #ffffff;
      --border-light: #e5e7eb;
    }
    * { transition: all .25s ease; }
    @media (prefers-reduced-motion: reduce) { * { transition: none !important; animation: none !important; } }

    body { 
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      background: #ffffff;
      font-size: 16px; /* Prevent zoom on iOS */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      touch-action: manipulation; /* Improve touch response */
    }
    .btn-wa { 
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); 
      border: none; 
      color: #fff;
      box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
      min-height: 48px; /* Touch-friendly button size */
      font-size: 1.1rem;
      font-weight: 600;
    }
    .btn-wa:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(22, 163, 74, 0.4);
    }
    .btn-primary { 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
      border: none;
      box-shadow: 0 4px 15px rgba(55, 65, 81, 0.3);
      min-height: 48px; /* Touch-friendly button size */
      font-size: 1.1rem;
      font-weight: 600;
    }
    .btn-primary:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(55, 65, 81, 0.4);
    }

    .hero {
      position: relative; min-height: 85vh; display: grid; place-items: center;
      color: #fff; text-align: center; overflow: hidden; 
      background: #1f2937; /* Fallback color */
    }
    @media (max-width: 768px) {
      .hero {
        min-height: 75vh;
        padding: 2rem 0;
      }
      .hero h1 {
        font-size: 1.8rem !important;
        line-height: 1.3;
        margin-bottom: 1rem !important;
      }
      .hero .lead {
        font-size: 1rem !important;
        margin-bottom: 2rem !important;
      }
    }
    .hero-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
    }
    .hero::before { 
      content:""; position:absolute; inset:0; z-index: 2;
      background: radial-gradient(circle at 30% 70%, rgba(0,0,0,0.3) 0%, transparent 50%),
                  radial-gradient(circle at 70% 30%, rgba(0,0,0,0.2) 0%, transparent 50%);
    }
    .hero::after { 
      content:""; position:absolute; inset:0; z-index: 3;
      background: linear-gradient(135deg, rgba(31, 41, 55, 0.7) 0%, rgba(17, 24, 39, 0.6) 100%);
    }
    .hero > .content { position: relative; z-index: 4; }
    .hero h1 { font-weight: 800; letter-spacing: -0.02em; }
    .navbar {
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-light);
    }
    .navbar-brand {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
    }
    .section-title { 
      font-weight: 800; 
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .badge-new { 
      background: linear-gradient(135deg, var(--accent) 0%, var(--primary-light) 100%); 
      color: white;
      font-weight: 600;
    }
    .badge-used { background: #a78bfa; }
    .shadow-soft { 
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08), 0 10px 20px rgba(0, 0, 0, 0.05); 
    }
    .list-hero li { color: #e2e8f0; }
    .contact-photo { width: 112px; height: 112px; object-fit: cover; border-radius: 999px; border: 4px solid #fff; }
    .whatsapp-chip { 
      display: inline-flex; align-items: center; gap: .5rem; 
      background: linear-gradient(135deg, rgba(22, 163, 74, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%); 
      color: var(--accent); 
      padding: .5rem 1rem; border-radius: 999px; font-weight: 600; font-size: .9rem;
      border: 1px solid rgba(22, 163, 74, 0.2);
    }
    .whatsapp-chip svg { width: 18px; height: 18px; }
    .map-embed { border: 0; width: 100%; height: 260px; border-radius: 1rem; }

    /* Mobile-optimized card design */
    .car-card { 
      border: none; border-radius: 1rem; overflow: hidden; 
      background: #ffffff;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      border: 1px solid #f1f5f9;
      margin-bottom: 1.5rem;
    }
    .car-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
    }
    @media (max-width: 768px) {
      .car-card {
        margin-bottom: 1rem;
        border-radius: 0.75rem;
      }
      .car-card:hover {
        transform: translateY(-2px);
      }
    }
    .car-card .img-wrap{
      position: relative; width: 100%; aspect-ratio: 16 / 9; overflow: hidden;
      background: #f3f4f6;
    }
    .car-card .img-wrap img{
      width: 100%; height: 100%; object-fit: cover; display: block; transition: transform .4s ease;
      background: #f8f9fa;
    }
    .car-card .img-wrap img[src$=".avif"] {
      image-rendering: auto;
    }
    .car-card:hover .img-wrap img{ transform: scale(1.04); }

    .price-badge{
      position: absolute; right: 1rem; bottom: 1rem;
      background: linear-gradient(135deg, rgba(31, 41, 55, 0.9) 0%, rgba(17, 24, 39, 0.9) 100%); 
      color: #fff; padding: .5rem .8rem;
      border-radius: .75rem; font-weight: 700; font-size: 1rem; 
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    @media (max-width: 768px) {
      .price-badge {
        font-size: 0.9rem;
        padding: 0.4rem 0.7rem;
        right: 0.75rem;
        bottom: 0.75rem;
      }
    }
    .car-card .card-body{ display:flex; flex-direction:column; }
    .car-card .buy-wrap{ margin-top:auto; }

    /* Floating WhatsApp Button - Mobile Optimized */
    .fab-wa {
      position: fixed; right: 20px; bottom: 20px; z-index: 1100;
      display: inline-flex; align-items: center; justify-content: center;
      width: 60px; height: 60px; border-radius: 999px; color: #fff;
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
      box-shadow: 0 15px 35px rgba(22, 163, 74, 0.3), 0 8px 15px rgba(0, 0, 0, 0.1);
      transition: all .3s ease;
      text-decoration: none;
    }
    .fab-wa:hover { 
      transform: translateY(-4px) scale(1.05); 
      box-shadow: 0 20px 40px rgba(22, 163, 74, 0.4), 0 10px 20px rgba(0, 0, 0, 0.15); 
      color: #fff;
    }
    .fab-wa svg { width: 28px; height: 28px; }
    @media (max-width: 768px) {
      .fab-wa {
        width: 56px;
        height: 56px;
        right: 16px;
        bottom: 16px;
      }
      .fab-wa svg { width: 26px; height: 26px; }
    }
    
    /* Mobile-first responsive styles */
    @media (max-width: 768px) {
      .container {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      
      .navbar-brand {
        font-size: 1.2rem;
      }
      
      .section-title {
        font-size: 1.5rem !important;
        margin-bottom: 1rem !important;
      }
      
      .card-body {
        padding: 1rem;
      }
      
      .btn {
        font-size: 1rem;
        padding: 0.75rem 1.5rem;
      }
      
      .btn-lg {
        font-size: 1.1rem;
        padding: 0.875rem 1.75rem;
      }
      
      .whatsapp-chip {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
      }
      
      .list-hero {
        flex-direction: column;
        gap: 0.5rem !important;
        font-size: 0.9rem;
      }
      
      .contact-photo {
        width: 80px;
        height: 80px;
      }
      
      .form-control, .form-select {
        font-size: 16px; /* Prevent zoom on iOS */
        padding: 0.75rem;
      }
      
      .modal-body {
        padding: 1rem;
      }
      
      .car-card .card-title {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
      }
      
      .car-card .card-text {
        font-size: 0.9rem;
        line-height: 1.4;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary sticky-top shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">Alghanim MG Kuwait</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="#cars">السيارات</a></li>
          <li class="nav-item"><a class="nav-link" href="#contact">تواصل</a></li>
        </ul>
        <a id="ctaWhatsAppTop" class="btn btn-wa ms-lg-3 text-white fw-semibold" target="_blank" rel="noopener">تواصل واتساب</a>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <header class="hero">
    <video class="hero-video" autoplay muted loop playsinline>
      <source src="mg video.mp4" type="video/mp4">
      <source src="mg video.webm" type="video/webm">
      <!-- Fallback for browsers that don't support video -->
      Your browser does not support the video tag.
    </video>
    <div class="content container py-5">
      <div class="mx-auto" style="max-width: 840px;">
        <span class="whatsapp-chip mb-3">
          <svg viewBox="0 0 32 32" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M19.11 17.19c-.3-.15-1.76-.86-2.03-.96-.27-.1-.47-.15-.67.15-.2.3-.77.96-.95 1.16-.17.2-.35.22-.65.07-.3-.15-1.28-.47-2.44-1.5-.9-.8-1.5-1.78-1.67-2.08-.17-.3-.02-.46.13-.61.13-.13.3-.35.45-.52.15-.17.2-.3.3-.5.1-.2.05-.37-.02-.52-.08-.15-.67-1.6-.92-2.2-.24-.58-.49-.5-.67-.5-.17 0-.37-.02-.57-.02-.2 0-.52.07-.8.37-.27.3-1.04 1-1.04 2.44 0 1.44 1.07 2.83 1.22 3.02.15.2 2.1 3.2 5.08 4.48.71.31 1.27.49 1.7.63.71.23 1.36.2 1.88.12.57-.09 1.76-.72 2-1.42.25-.7.25-1.3.17-1.42-.07-.12-.27-.2-.57-.35z"/><path d="M26.87 5.14A12.8 12.8 0 0 0 16 1.33C8.6 1.33 2.6 7.33 2.6 14.74c0 2.34.61 4.64 1.76 6.66L2 30.67l9.45-2.27a13.35 13.35 0 0 0 4.55.78c7.4 0 13.4-6 13.4-13.4 0-3.58-1.39-6.95-3.94-9.43zM16 27.33c-1.38 0-2.75-.26-4.03-.77l-.86-.36-5.6 1.35 1.35-5.36-.38-.88a10.8 10.8 0 0 1-1.16-4.57c0-5.97 4.86-10.8 10.8-10.8 2.88 0 5.58 1.13 7.62 3.17a10.7 10.7 0 0 1 3.17 7.63c0 5.97-4.86 10.8-10.8 10.8z"/></svg>
          رسالة واتساب فورية
        </span>
        <h1 class="display-4 mb-3">توكيل <span class="text-success">إم جي الرسمي</span> - مجموعة الغانم الكويت</h1>
        <p class="lead mb-4">الوكيل الحصري والمعتمد لسيارات إم جي في الكويت - تصفح واختر من أحدث موديلات إم جي الجديدة 2025 وأرسل طلبك بضغطة زر — مباشرةً على واتساب للحصول على أفضل العروض والخدمات الحصرية.</p>
        <div class="d-flex gap-3 justify-content-center flex-wrap mb-3">
          <a id="ctaWhatsAppHero" class="btn btn-lg btn-wa text-white fw-semibold px-4" target="_blank" rel="noopener">تواصل الآن</a>
          <a href="#cars" class="btn btn-outline-light btn-lg fw-semibold px-4">تصفّح السيارات</a>
        </div>
        <ul class="list-unstyled d-flex gap-4 mt-4 justify-content-center list-hero">
          <li>✔ توكيل إم جي الحصري</li>
          <li>✔ ضمان الوكيل المعتمد</li>
          <li>✔ خدمات ما بعد البيع الرسمية</li>
        </ul>
      </div>
    </div>
  </header>

  <!-- Cars -->
  <section id="cars" class="py-5" style="background: #ffffff;">
    <div class="container">
      <div class="d-flex align-items-end justify-content-between flex-wrap gap-3 mb-4">
        <div>
          <h2 class="section-title mb-1">توكيل إم جي الرسمي - أحدث سيارات إم جي الجديدة 2025 بالكويت</h2>
          <p class="text-secondary mb-0">الوكيل الحصري والمعتمد - جميع سياراتنا جديدة 2025 بضمان الوكيل الرسمي. اختر سيارة إم جي الجديدة واضغط <strong>اشترِ الآن</strong> لإرسال التفاصيل على واتساب.</p>
        </div>
        <div class="d-flex gap-2 flex-wrap align-items-center">
          <input id="searchInput" type="search" class="form-control" placeholder="ابحث بالاسم..." style="max-width: 200px; min-width: 150px;">
          <select id="filterSelect" class="form-select" style="max-width: 160px; min-width: 140px;">
            <option value="all">جميع موديلات إم جي الجديدة</option>
            <option value="new">موديلات جديدة</option>
            <option value="premium">فئة فاخرة</option>
            <option value="electric">سيارات كهربائية</option>
          </select>
        </div>
      </div>

      <div id="carsGrid" class="row g-3"></div>
    </div>
  </section>

  <!-- Floating WhatsApp Button -->
  <a id="fabWhatsApp" class="fab-wa" target="_blank" rel="noopener" aria-label="دردشة واتساب">
    <svg viewBox="0 0 32 32" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M19.11 17.19c-.3-.15-1.76-.86-2.03-.96-.27-.1-.47-.15-.67.15-.2.3-.77.96-.95 1.16-.17.2-.35.22-.65.07-.3-.15-1.28-.47-2.44-1.5-.9-.8-1.5-1.78-1.67-2.08-.17-.3-.02-.46.13-.61.13-.13.3-.35.45-.52.15-.17.2-.3.3-.5.1-.2.05-.37-.02-.52-.08-.15-.67-1.6-.92-2.2-.24-.58-.49-.5-.67-.5-.17 0-.37-.02-.57-.02-.2 0-.52.07-.8.37-.27.3-1.04 1-1.04 2.44 0 1.44 1.07 2.83 1.22 3.02.15.2 2.1 3.2 5.08 4.48.71.31 1.27.49 1.7.63.71.23 1.36.2 1.88.12.57-.09 1.76-.72 2-1.42.25-.7.25-1.3.17-1.42-.07-.12-.27-.2-.57-.35z"/><path d="M26.87 5.14A12.8 12.8 0 0 0 16 1.33C8.6 1.33 2.6 7.33 2.6 14.74c0 2.34.61 4.64 1.76 6.66L2 30.67l9.45-2.27a13.35 13.35 0 0 0 4.55.78c7.4 0 13.4-6 13.4-13.4 0-3.58-1.39-6.95-3.94-9.43zM16 27.33c-1.38 0-2.75-.26-4.03-.77l-.86-.36-5.6 1.35 1.35-5.36-.38-.88a10.8 10.8 0 0 1-1.16-4.57c0-5.97 4.86-10.8 10.8-10.8 2.88 0 5.58 1.13 7.62 3.17a10.7 10.7 0 0 1 3.17 7.63c0 5.97-4.86 10.8-10.8 10.8z"/></svg>
  </a>

  <!-- Contact -->
  <section id="contact" class="py-5" style="background: #ffffff;">
    <div class="container">
      <div class="row g-4 align-items-center">
        <div class="col-lg-6">
          <div class="d-flex align-items-center gap-3 mb-3">
            <img id="contactPhoto" class="contact-photo shadow-soft" alt="صورة المندوب" src="https://images.unsplash.com/photo-1531123414780-f742b7a5e0a8?q=80&w=600&auto=format&fit=crop" loading="lazy">
            <div>
              <h3 class="mb-1" id="salesName">Ahmed Abdelwahab</h3>
              <div class="text-secondary">مستشار مبيعات - توكيل إم جي الرسمي، الكويت</div>
            </div>
          </div>
          <p class="text-muted">أحمد عبدالوهاب - مستشار مبيعات في توكيل إم جي الرسمي بالكويت (مجموعة الغانم). أساعدك تختار سيارة إم جي الجديدة والخطة المناسبة لك مع ضمان الوكيل المعتمد وخدمات ما بعد البيع الحصرية. أرسل طلبك على واتساب وبردّ عليك بسرعة بالتوافر، تجربة القيادة، وأفضل العروض لسيارات إم جي الجديدة.</p>
          <div class="d-flex gap-2 flex-wrap">
            <a id="ctaWhatsAppContact" class="btn btn-wa text-white fw-semibold" target="_blank" rel="noopener">واتساب</a>
            <a id="ctaCall" class="btn btn-outline-success fw-semibold" target="_blank" rel="noopener">اتصال</a>
            <a id="ctaEmail" class="btn btn-outline-secondary fw-semibold" target="_blank" rel="noopener">إيميل</a>
          </div>
        </div>
        <div class="col-lg-6">
          <iframe id="mapEmbed" class="map-embed shadow-soft" loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade" src="https://maps.google.com/maps?q=Kuwait%20City&t=&z=12&ie=UTF8&iwloc=&output=embed"></iframe>
        </div>
      </div>
    </div>
  </section>

  <!-- Purchase Modal - Mobile Optimized -->
  <div class="modal fade" id="purchaseModal" tabindex="-1" aria-labelledby="purchaseLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="purchaseLabel">نموذج شراء سيارة</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="purchaseForm" class="needs-validation" novalidate>
            <div class="mb-3">
              <label for="carName" class="form-label">السيارة</label>
              <input type="text" id="carName" class="form-control" readonly>
            </div>
            <div class="row g-3">
              <div class="col-sm-6">
                <label for="custName" class="form-label">اسمك</label>
                <input type="text" id="custName" class="form-control" placeholder="أحمد علي" required>
                <div class="invalid-feedback">فضلاً اكتب اسمك.</div>
              </div>
              <div class="col-sm-6">
                <label for="custPhone" class="form-label">رقمك</label>
                <input type="tel" id="custPhone" class="form-control" placeholder="+965 9690 2117" pattern="^[0-9+()\-\s]{7,}$" required>
                <div class="form-text">إذا كنت خارج الكويت ضِف كود الدولة.</div>
                <div class="invalid-feedback">فضلاً اكتب رقم صحيح.</div>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label">طريقة الدفع</label>
              <div class="d-flex gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="paymentMethod" id="payCash" value="Cash" checked>
                  <label class="form-check-label" for="payCash">كاش</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="paymentMethod" id="payFinance" value="Finance">
                  <label class="form-check-label" for="payFinance">تمويل</label>
                </div>
              </div>
            </div>

            <div id="financeFields" class="row g-3 mt-1" style="display:none;">
              <div class="col-12">
                <div class="row g-3">
                  <div class="col-sm-4">
                    <label for="bankSelect" class="form-label">شركة التمويل</label>
                    <select id="bankSelect" class="form-select">
                      <option value="" selected disabled>اختر شركة تمويل…</option>
                    </select>
                    <div class="invalid-feedback">فضلاً اختر شركة تمويل.</div>
                  </div>
                  <div class="col-sm-2">
                    <label for="loanYears" class="form-label">سنوات</label>
                    <select id="loanYears" class="form-select">
                      <option value="" selected disabled>—</option>
                    </select>
                    <div class="invalid-feedback">فضلاً اختر السنوات.</div>
                  </div>
                  <div class="col-sm-3">
                    <label for="apr" class="form-label">نسبة الفائدة %</label>
                    <input type="number" id="apr" class="form-control" value="" min="0" step="0.1" readonly style="background-color: #f8f9fa;" placeholder="تحدد حسب الشركة">
                  </div>
                  <div class="col-sm-3">
                    <label for="downPayment" class="form-label">الدفعة الأولى (د.ك)</label>
                    <input type="number" id="downPayment" class="form-control" value="0" min="0" step="100">
                  </div>
                </div>
                <div class="row g-3 mt-1">
                  <div class="col-sm-4">
                    <label for="budget" class="form-label">القسط المناسب شهريًا (د.ك)</label>
                    <input type="number" id="budget" class="form-control" min="0" step="10">
                  </div>
                  <div class="col-sm-4">
                    <label class="form-label">القسط التقديري</label>
                    <input type="text" id="emi" class="form-control" readonly>
                  </div>
                  <div class="col-sm-4">
                    <label class="form-label">الإجمالي المستحق</label>
                    <input type="text" id="totalPayable" class="form-control" readonly>
                  </div>
                </div>
                <div class="row g-3 mt-1">
                  <div class="col-sm-4">
                    <label class="form-label">إجمالي الأرباح/الفوائد</label>
                    <input type="text" id="totalInterest" class="form-control" readonly>
                  </div>
                  <div class="col-sm-8">
                    <label class="form-label">حالة الميزانية</label>
                    <div id="budgetStatus" class="form-control" style="height:auto; min-height: 38px; display:flex; align-items:center;">—</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-4 d-grid">
              <button class="btn btn-wa text-white fw-semibold" type="submit">إرسال على واتساب</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Car Details Modal - Mobile Optimized -->
  <div class="modal fade" id="carDetailsModal" tabindex="-1" aria-labelledby="carDetailsLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-md-down">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="carDetailsLabel">تفاصيل السيارة</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <!-- Car Image Gallery -->
          <div id="carImageCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner" id="carouselImages">
              <!-- Images will be populated by JavaScript -->
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carImageCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carImageCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
            <div class="carousel-indicators" id="carouselIndicators">
              <!-- Indicators will be populated by JavaScript -->
            </div>
          </div>
          
          <!-- Car Details Content -->
          <div class="p-4">
            <div class="row">
              <div class="col-lg-8">
                <h3 id="modalCarName" class="mb-3"></h3>
                <div id="modalCarBadge" class="mb-3"></div>
                
                <h5 class="text-success mb-3">المواصفات والمزايا</h5>
                <div id="carFeatures" class="mb-4">
                  <!-- Features will be populated by JavaScript -->
                </div>
                
                <h5 class="text-success mb-3">ضمان الوكيل الرسمي</h5>
                <div class="warranty-info mb-4">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="d-flex align-items-center p-3 bg-light rounded">
                        <i class="text-success me-2" style="font-size: 1.5rem;">✓</i>
                        <div>
                          <strong>5 سنوات</strong><br>
                          <small class="text-muted">ضمان الوكيل الرسمي</small>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="d-flex align-items-center p-3 bg-light rounded">
                        <i class="text-success me-2" style="font-size: 1.5rem;">✓</i>
                        <div>
                          <strong>100,000 كم</strong><br>
                          <small class="text-muted">ضمان قطع الغيار</small>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="d-flex align-items-center p-3 bg-light rounded">
                        <i class="text-success me-2" style="font-size: 1.5rem;">✓</i>
                        <div>
                          <strong>صيانة مجانية</strong><br>
                          <small class="text-muted">لأول 3 سنوات</small>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="d-flex align-items-center p-3 bg-light rounded">
                        <i class="text-success me-2" style="font-size: 1.5rem;">✓</i>
                        <div>
                          <strong>خدمة 24/7</strong><br>
                          <small class="text-muted">مساعدة على الطريق</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-lg-4">
                <div class="sticky-top">
                  <div class="card border-success">
                    <div class="card-body text-center">
                      <h4 class="text-success mb-3" id="modalCarPrice"></h4>
                      <p class="text-muted mb-3">السعر شامل جميع الرسوم والضرائب</p>
                      <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" id="modalBuyBtn">🚗 اشترِ الآن</button>
                        <button class="btn btn-wa text-white" id="modalWhatsAppBtn">📱 واتساب</button>
                        <button class="btn btn-outline-primary" id="modalBrochureBtn">📋 تحميل البروشور</button>
                      </div>
                      <div class="mt-3 pt-3 border-top">
                        <small class="text-muted">
                          من التوكيل الرسمي لإم جي في الكويت
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
    <div id="toast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          تم تجهيز طلبك ✅ اضغط <strong>إرسال</strong> في واتساب. برجع لك بأسرع وقت.
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <footer class="py-4 border-top" style="background: #ffffff;">
    <div class="container small text-center text-muted">
    © <span id="year"></span> <span id="footerName">Alghanim Sons Group | مجموعة الغانم وأولاده</span>. جميع الحقوق محفوظة.
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    // ====== CONFIG: EDIT THESE ======
    // Updated for Kuwait
    const CONFIG = {
      salesName: "Ahmed Abdelwahab",
      whatsappNumberE164: "96596902117",   // recipient = +965 9690 2117 (Kuwait number)
      callNumber: "+965 9690 2117",
      email: "aradwan@alghanimsons.com",
      contactPhoto: "YOUR_REAL_PHOTO_URL_HERE",
      mapEmbedSrc: "https://maps.google.com/maps?q=Alghanim+Motors+Kuwait&t=&z=13&ie=UTF8&iwloc=&output=embed",
      currencyLocale: "en-KW",
      currency: "KWD",

      themeRotateSeconds: 15,
      themes: [
        { wa: '#16a34a', primary: '#374151', dark: '#0f172a' },
        { wa: '#15803d', primary: '#4b5563', dark: '#0f172a' },
        { wa: '#059669', primary: '#6b7280', dark: '#0f172a' },
        { wa: '#047857', primary: '#1f2937', dark: '#0f172a' }
      ]
    };

    const FINANCING_COMPANIES = [
      { name: "شركة التسهيلات التجارية", rate: 6.5 },
      { name: "شركة تسهيلات الساير", rate: 8.5 },
      { name: "شركة المنار للإيجارة", rate: 7.0 }
    ];

    const CARS = [
      {
        id: "mgrx9_2025",
        name: "MG RX9 2025",
        price: 3499,
        condition: "new",
        category: "premium",
        image: "images/mg-rx9/mg-rx9.avif",
        imageFolder: "images/mg-rx9/",
        images: ["mg-rx9.avif", "mg-rx92.avif", "mg-rx93.avif", "mg-rx94.avif", "mg_rx9.avif", "mg_rx9_37.avif"],
        features: ["محرك 2.0 تيربو قوي", "نظام دفع رباعي AWD", "فتحة سقف بانورامية", "نظام ملاحة ذكي", "مقاعد جلدية فاخرة", "نظام صوتي متطور"],
        description: "إم جي آر إكس 9 - سيارة SUV فاخرة تجمع بين الأناقة والقوة. مجهزة بأحدث التقنيات وأنظمة الأمان المتطورة.",
        brochure: "broushors/mg_rx9_brochure_en_v6.pdf"
      },
      {
        id: "mg5_2025",
        name: "MG 5 2025",
        price: 3599,
        condition: "new",
        category: "new",
        image: "images/mg-5/mg-5.avif",
        imageFolder: "images/mg-5/",
        images: ["mg-5.avif", "mg-52.avif", "mg-53.avif", "mg-54.avif", "mg-55.avif"],
        features: ["محرك 1.5 لتر اقتصادي", "ناقل حركة CVT", "شاشة لمس 10 بوصة", "نظام أمان متقدم", "مقاعد مريحة", "نظام تكييف ذكي"],
        description: "إم جي 5 - سيارة سيدان عصرية واقتصادية. مثالية للعائلات والاستخدام اليومي.",
        brochure: "broushors/mg_5_brochure_en_v03_lowres_1_.pdf"
      },
      {
        id: "mg4_electric_2025",
        name: "MG 4 Electric 2025",
        price: 8900,
        condition: "new",
        category: "electric",
        image: "images/mg-4/mg-4.avif",
        imageFolder: "images/mg-4/",
        images: ["mg-4.avif", "mg-42.avif", "mg-43.avif", "mg-44.avif", "mg-45.avif", "mg-ev.avif"],
        features: ["محرك كهربائي قوي", "مدى 450 كم", "شحن سريع DC", "أنظمة ذكية", "صديق للبيئة", "تقنية متطورة"],
        description: "إم جي 4 الكتريك - مستقبل القيادة. سيارة كهربائية بالكامل مع مدى طويل وشحن سريع.",
        brochure: "broushors/mg_4_brochure_eng_v6.pdf"
      },
      {
        id: "mg7_2025",
        name: "MG 7 1.5 Turbo 2025",
        price: 6399,
        condition: "new",
        category: "premium",
        image: "images/mg-7/mg-7.avif",
        imageFolder: "images/mg-7/",
        images: ["mg-7.avif", "mg-72.avif", "mg-73.avif", "mg-74.avif", "mg-75.avif", "mg-76.avif", "mg76.avif"],
        features: ["محرك 1.5 تيربو", "قوة 170 حصان", "ناقل حركة CVT", "مقاعد جلدية فاخرة", "شاشة لمس 12.3 بوصة", "نظام صوتي متطور", "فتحة سقف"],
        description: "إم جي 7 تيربو 1.5 - سيارة سيدان فاخرة بمحرك تيربو اقتصادي. تجمع بين الأداء والاقتصاد في الوقود.",
        brochure: "broushors/mg_7_brochure.pdf"
      },
      {
        id: "mg7_turbo_2025",
        name: "MG 7 2.0 Turbo 2025",
        price: 7299,
        condition: "new",
        category: "premium",
        image: "mg-7 2.0 turbo.webp",
        imageFolder: "images/mg-7/",
        images: ["mg-7 2.0 turbo.webp", "mg-72.avif", "mg-7.avif", "mg-73.avif", "mg-74.avif", "mg-75.avif", "mg-76.avif", "mg76.avif"],
        features: ["محرك 2.0 تيربو عالي الأداء", "قوة 245 حصان", "نظام دفع رباعي AWD", "مقاعد جلدية رياضية", "شاشة لمس 12.3 بوصة", "نظام قيادة رياضية", "فتحة سقف بانورامية", "نظام صوتي BOSE فائق"],
        description: "إم جي 7 تيربو - نسخة عالية الأداء من سيارة الأعمال الفاخرة. محرك تيربو قوي ومواصفات رياضية متطورة.",
        brochure: "broushors/mg_7_brochure.pdf"
      },
      {
        id: "mg3_2025",
        name: "MG 3 2025",
        price: 3499,
        condition: "new",
        category: "new",
        image: "images/mg-3/mg-33.avif",
        imageFolder: "images/mg-3/",
        images: ["mg-33.avif", "mg-35.avif", "mg_32.avif", "02.avif"],
        features: ["محرك 1.5 لتر", "ناقل حركة يدوي", "تصميم عصري", "نظام أمان أساسي", "اقتصادي في الوقود", "مثالي للمدينة"],
        description: "إم جي 3 - سيارة مدمجة عملية واقتصادية. مثالية للشباب والعائلات الصغيرة."
      },
      {
        id: "mg_whale_2025",
        name: "MG Whale 2025",
        price: 7777,
        condition: "new",
        category: "premium",
        image: "images/mg-rx9/mg_rx9.avif",
        imageFolder: "images/mg-rx9/",
        images: ["mg_rx9.avif", "mg-rx9.avif", "mg-rx92.avif", "mg-rx93.avif"],
        features: ["محرك هجين قوي", "سيارة SUV فاخرة", "مقاعد 7 راكب", "نظام معلومات متطور", "فتحة سقف بانورامية", "نظام قيادة ذكية"],
        description: "إم جي ويل - أكبر وأفخم سيارات إم جي. SUV فاخرة للعائلات الكبيرة."
      },
      {
        id: "mg_one_2025",
        name: "MG One 2025",
        price: 6666,
        condition: "new",
        category: "new",
        image: "images/mg-one/mg-one.avif",
        imageFolder: "images/mg-one/",
        images: ["mg-one.avif", "mg-one2.avif", "mg-one3.avif", "mg-one4.avif", "mg-one5.avif"],
        features: ["محرك 1.5 تيربو", "نظام دفع أمامي", "شاشة لمس ذكية", "نظام أمان متقدم", "مقاعد مريحة", "تصميم عصري"],
        description: "إم جي ون - SUV مدمجة تجمع بين العملية والأناقة. مثالية للعائلات العصرية.",
        brochure: "broushors/mg_one_brochure_english.pdf"
      },
      {
        id: "mg_rx5_2025",
        name: "MG RX5 2025",
        price: 5999,
        condition: "new",
        category: "new",
        image: "images/mg-rx5/mg-rx5.avif",
        imageFolder: "images/mg-rx5/",
        images: ["mg-rx5.avif", "mg-rx52.avif", "mg-rx53.avif"],
        features: ["محرك 1.5 تيربو", "نظام دفع رباعي", "شاشة لمس 10.1 بوصة", "نظام ملاحة", "مقاعد مريحة", "نظام قيادة مساعد"],
        description: "إم جي آر إكس 5 - SUV متطورة بتقنيات ذكية. مثالية للرحلات والمغامرات.",
        brochure: "broushors/mg_rx5_brochure_eng_regional_smme.pdf"
      },
      {
        id: "mg_gt_2025",
        name: "MG GT 2025",
        price: 5499,
        condition: "new",
        category: "premium",
        image: "images/mg-gt/mg-gt.avif",
        imageFolder: "images/mg-gt/",
        images: ["mg-gt.avif", "mg-gt2.avif", "mg-gt3.avif"],
        features: ["محرك V6 قوي", "دفع خلفي رياضي", "مقاعد جلدية رياضية", "نظام تعليق رياضي", "شاشة لمس متطورة", "أنظمة قيادة رياضية"],
        description: "إم جي جي تي - كوبيه رياضية أنيقة. تصميم جذاب مع أداء رياضي مميز للقيادة الحماسية.",
        brochure: "broushors/mg_gt_leaflet_english_aw_ol_optimized_new.pdf"
      },
      {
        id: "mgzs_2025",
        name: "MG ZS 2025",
        price: 4444,
        condition: "new",
        category: "new",
        image: "images/mg-zs/mg-zs.avif",
        imageFolder: "images/mg-zs/",
        images: ["mg-zs.avif", "mg-zs2.avif", "mg-zs3.avif", "mg-zs4.avif"],
        features: ["محرك 1.5 لتر", "SUV مدمجة", "شاشة لمس 8 بوصة", "نظام أمان أساسي", "مساحة تخزين كبيرة", "اقتصادي في الوقود"],
        description: "إم جي زد إس - SUV مدمجة عملية واقتصادية. مثالية للعائلات والاستخدام اليومي في المدينة.",
        brochure: "broushors/mg_zs_brochure_eng_v1.3_new_1_.pdf"
      },
      {
        id: "mghs_2025",
        name: "MG HS 2025",
        price: 6999,
        condition: "new",
        category: "new",
        image: "images/mg-hs images/mg-hs.avif",
        imageFolder: "images/mg-hs images/",
        images: ["mg-hs.avif", "mg-hs2.avif", "mg-hs3.avif", "mg-hs4.avif"],
        features: ["محرك 2.0 تيربو", "نظام دفع رباعي AWD", "شاشة لمس 12.3 بوصة", "نظام ملاحة متطور", "مقاعد جلدية مدفأة", "نظام أمان شامل"],
        description: "إم جي إتش إس - SUV متوسطة فاخرة تجمع بين الراحة والأداء. مثالية للعائلات التي تبحث عن الفخامة والعملية.",
        brochure: "broushors/mg_hs_brochure_en_r07_lowres.pdf"
      }
    ];
    // ====== END CONFIG ======

    const $  = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const money = (v) => new Intl.NumberFormat(CONFIG.currencyLocale, { style: 'currency', currency: CONFIG.currency }).format(v);

    // Populate financing companies and years
    function initFinanceOptions() {
      const companySelect = $('#bankSelect');
      FINANCING_COMPANIES.forEach(company => {
        const opt = document.createElement("option");
        opt.value = `${company.name} (${company.rate}%)`;
        opt.textContent = `${company.name} - ${company.rate}%`;
        opt.setAttribute('data-rate', company.rate);
        companySelect.appendChild(opt);
      });
      const yearsSelect = $('#loanYears');
      for (let y=1; y<=4; y++) {
        const opt = document.createElement("option");
        opt.value = String(y); opt.textContent = `${y} سنة`;
        yearsSelect.appendChild(opt);
      }
    }

    function carBadge(condition, category) {
      if (category === 'premium') {
        return `<span class="badge" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; font-weight: 600;">Premium MG</span>`;
      } else if (category === 'electric') {
        return `<span class="badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: 600;">Electric MG</span>`;
      } else {
        return `<span class="badge" style="background: linear-gradient(135deg, #374151 0%, #1f2937 100%); color: white; font-weight: 600;">New MG 2025</span>`;
      }
    }

    function renderCars(list) {
      const grid = $('#carsGrid');
      grid.innerHTML = "";
      if (!list.length) {
        grid.innerHTML = `<div class="col-12"><div class="alert alert-warning">لا توجد سيارات مطابقة لبحثك.</div></div>`;
        return;
      }
      list.forEach(car => {
        const col = document.createElement("div");
        col.className = "col-12 col-sm-6 col-lg-4";
        col.innerHTML = `
          <div class="card h-100 shadow-soft car-card" data-car-id="${car.id}" style="cursor: pointer;">
            <div class="img-wrap">
              <img src="${car.image}" alt="${car.name}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              <div style="display:none; justify-content:center; align-items:center; background:#f8f9fa; color:#6b7280; font-size:14px; text-align:center; padding:2rem;">
                <div>
                  <div style="font-size:2rem; margin-bottom:0.5rem;">🚗</div>
                  <div>صورة ${car.name}</div>
                </div>
              </div>
              <span class="price-badge">${money(car.price)}</span>
              <div class="position-absolute top-0 end-0 p-2">
                ${carBadge(car.condition, car.category)}
              </div>
              <div class="position-absolute bottom-0 start-0 p-3">
                <small class="text-white bg-dark px-2 py-1 rounded" style="background: rgba(0,0,0,0.7) !important;">اضغط لمزيد من التفاصيل</small>
              </div>
            </div>
            <div class="card-body">
              <h5 class="card-title mb-1">${car.name}</h5>
              <p class="text-muted mb-3">سيارة إم جي جديدة من التوكيل الرسمي بضمان الوكيل المعتمد وأحدث المواصفات وخدمات ما بعد البيع الحصرية.</p>
              <div class="buy-wrap d-grid">
                <button class="btn btn-primary fw-semibold" data-car="${car.name}" data-bs-toggle="modal" data-bs-target="#purchaseModal">🚗 اشترِ الآن</button>
              </div>
            </div>
          </div>`;
        grid.appendChild(col);
      });
    }

    function attachBuyButtons() {
      $('#carsGrid').addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-car]');
        const card = e.target.closest('.car-card[data-car-id]');
        
        if (btn) {
          $('#carName').value = btn.getAttribute('data-car');
        } else if (card) {
          // Open car details modal
          const carId = card.getAttribute('data-car-id');
          const car = CARS.find(c => c.id === carId);
          if (car) {
            showCarDetails(car);
          }
        }
      });
    }
    
    function showCarDetails(car) {
      // Set car name and price
      $('#modalCarName').textContent = car.name;
      $('#modalCarPrice').textContent = money(car.price);
      $('#modalCarBadge').innerHTML = carBadge(car.condition, car.category);
      
      // Set features
      const featuresHtml = car.features ? car.features.map(f => `<li class="mb-2"><i class="text-success me-2">✓</i>${f}</li>`).join('') : '<li>مواصفات متميزة</li>';
      $('#carFeatures').innerHTML = `<ul class="list-unstyled">${featuresHtml}</ul>`;
      
      // Load images carousel
      loadCarImages(car);
      
      // Set up buy button
      $('#modalBuyBtn').onclick = () => {
        $('#carName').value = car.name;
        const detailsModal = bootstrap.Modal.getInstance($('#carDetailsModal'));
        detailsModal.hide();
        setTimeout(() => {
          new bootstrap.Modal($('#purchaseModal')).show();
        }, 300);
      };
      
      // Set up WhatsApp button
      $('#modalWhatsAppBtn').onclick = () => {
        const message = `مرحبا، أريد استفسار عن ${car.name} - السعر: ${money(car.price)}`;
        window.open(whatsappURL(message), '_blank');
      };
      
      // Set up Brochure download button
      const brochureBtn = $('#modalBrochureBtn');
      if (car.brochure) {
        brochureBtn.style.display = 'block';
        brochureBtn.onclick = () => {
          // Create a temporary anchor element to trigger download
          const link = document.createElement('a');
          link.href = car.brochure;
          link.download = car.brochure.split('/').pop(); // Use filename from path
          link.target = '_blank';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };
      } else {
        brochureBtn.style.display = 'none';
      }
      
      // Show modal
      new bootstrap.Modal($('#carDetailsModal')).show();
    }
    
    function loadCarImages(car) {
      const carouselImages = $('#carouselImages');
      const carouselIndicators = $('#carouselIndicators');
      
      carouselImages.innerHTML = '';
      carouselIndicators.innerHTML = '';
      
      const images = car.images || [car.image.split('/').pop()];
      const imageFolder = car.imageFolder || car.image.substring(0, car.image.lastIndexOf('/') + 1);
      
      images.forEach((img, index) => {
        // Create carousel item
        const item = document.createElement('div');
        item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
        item.innerHTML = `
          <img src="${imageFolder}${img}" class="d-block w-100" alt="${car.name}" style="height: 400px; object-fit: cover;" 
               onerror="this.style.display='none'">
        `;
        carouselImages.appendChild(item);
        
        // Create indicator
        const indicator = document.createElement('button');
        indicator.type = 'button';
        indicator.setAttribute('data-bs-target', '#carImageCarousel');
        indicator.setAttribute('data-bs-slide-to', index.toString());
        indicator.className = index === 0 ? 'active' : '';
        indicator.setAttribute('aria-label', `Slide ${index + 1}`);
        if (index === 0) indicator.setAttribute('aria-current', 'true');
        carouselIndicators.appendChild(indicator);
      });
    }

    function setupSearchFilter() {
      const input = $('#searchInput');
      const select = $('#filterSelect');
      const apply = () => {
        const q = input.value.trim().toLowerCase();
        const f = select.value;
        const filtered = CARS.filter(c => {
          const matchQ = !q || c.name.toLowerCase().includes(q);
          const matchF = f === 'all' || c.category === f;
          return matchQ && matchF;
        });
        renderCars(filtered);
      };
      input.addEventListener('input', apply);
      select.addEventListener('change', apply);
    }

    // Payment toggle and finance calculator
    function setupPaymentToggleV2() {
      const financeFields = $('#financeFields');
      const bankSelect = $('#bankSelect');
      const yearsSelect = $('#loanYears');
      const apr = $('#apr');
      const down = $('#downPayment');
      const emiOut = $('#emi');
      const budget = $('#budget');
      const totalPayable = $('#totalPayable');
      const totalInterest = $('#totalInterest');
      const budgetStatus = $('#budgetStatus');

      function update(){
        const method = document.querySelector('input[name="paymentMethod"]:checked').value;
        const show = method === 'Finance';
        financeFields.style.display = show ? 'block' : 'none';
        bankSelect.required = show; yearsSelect.required = show;
        if(!show){
          bankSelect.value=''; yearsSelect.value=''; emiOut.value=''; totalPayable.value=''; totalInterest.value='';
          budget.value=''; budgetStatus.textContent='—'; budgetStatus.style.color=''; budgetStatus.style.background='';
        } else calc();
      }

      function calc(){
        const carName = $('#carName').value;
        const car = CARS.find(c=>c.name===carName);
        if(!car) { 
          emiOut.value=''; totalPayable.value=''; totalInterest.value=''; budgetStatus.textContent='—'; 
          return; 
        }
        
        const carPrice = car.price;
        const downPayment = parseFloat(down.value) || 0;
        const principal = Math.max(0, carPrice - downPayment);
        const years = parseInt(yearsSelect.value) || 0;
        
        // Get interest rate from selected financing company
        const selectedOption = bankSelect.options[bankSelect.selectedIndex];
        const annualRate = selectedOption ? parseFloat(selectedOption.getAttribute('data-rate')) : 0;
        
        // Update APR display
        apr.value = annualRate || '';
        
        // Validate inputs
        if (!principal || !years || !annualRate || !bankSelect.value) { 
          emiOut.value=''; totalPayable.value=''; totalInterest.value=''; budgetStatus.textContent='—'; 
          return; 
        }
        
        // Convert annual rate to monthly rate
        const monthlyRate = annualRate / 100 / 12;
        const totalMonths = years * 12;
        
        // Calculate EMI using accurate formula
        // EMI = P × r × (1 + r)^n / [(1 + r)^n - 1]
        const numerator = principal * monthlyRate * Math.pow(1 + monthlyRate, totalMonths);
        const denominator = Math.pow(1 + monthlyRate, totalMonths) - 1;
        const monthlyEMI = numerator / denominator;
        
        // Calculate totals
        const totalAmount = monthlyEMI * totalMonths;
        const totalInterest = totalAmount - principal;
        
        // Display results
        emiOut.value = money(Math.round(monthlyEMI));
        totalPayable.value = money(Math.round(totalAmount + downPayment)); // Include down payment in total
        totalInterest.value = money(Math.round(totalInterest));
        
        // Budget comparison
        const budgetAmount = parseFloat(budget.value) || 0;
        if (budgetAmount > 0) {
          const difference = budgetAmount - monthlyEMI;
          if (difference >= 0) {
            budgetStatus.textContent = `ضمن الميزانية ✅ (توفّر ${money(Math.round(difference))} بالشهر)`;
            budgetStatus.style.background = '#e8fff2';
            budgetStatus.style.color = '#065f46';
          } else {
            budgetStatus.textContent = `يتجاوز الميزانية ❌ بمقدار ${money(Math.round(-difference))} بالشهر`;
            budgetStatus.style.background = '#fff1f2';
            budgetStatus.style.color = '#9f1239';
          }
        } else { 
          budgetStatus.textContent = '—'; 
          budgetStatus.style.color = ''; 
          budgetStatus.style.background = ''; 
        }
      }

      document.querySelectorAll('input[name="paymentMethod"]').forEach(r => r.addEventListener('change', update));
      [bankSelect, yearsSelect, down, budget].forEach(el=> el.addEventListener('change', calc));
      [down, budget].forEach(el=> el.addEventListener('input', calc));
      update();
    }

    function whatsappURL(message) {
      const base = `https://wa.me/${CONFIG.whatsappNumberE164}`;
      return `${base}?text=${encodeURIComponent(message)}`;
    }

    function setupForm() {
      const form = $('#purchaseForm');
      const toastEl = $('#toast');
      const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
      const modalEl = $('#purchaseModal');
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          return;
        }

        const car = $('#carName').value.trim();
        const name = $('#custName').value.trim();
        const phone = $('#custPhone').value.trim();
        const method = document.querySelector('input[name="paymentMethod"]:checked').value;
        const financingCompany = $('#bankSelect').value;
        const years = $('#loanYears').value;

        let lines = [
          `طلب سيارة إم جي جديدة من التوكيل الرسمي - مجموعة الغانم الكويت:`,
          `- العميل: ${name}`,
          `- الرقم: ${phone}`,
          `- السيارة: ${car}`,
          `- طريقة الدفع: ${method === 'Finance' ? 'تمويل' : 'كاش'}`
        ];
        if (method === 'Finance') {
          lines.push(`- شركة التمويل: ${financingCompany}`);
          lines.push(`- عدد السنوات: ${years}`);
          const aprVal = $('#apr').value;
          const downVal = $('#downPayment').value;
          const budgetVal = $('#budget').value;
          const totalVal = $('#totalPayable').value;
          const interestVal = $('#totalInterest').value;
          const emiVal = $('#emi').value;
          lines.push(`- نسبة الفائدة: ${aprVal}%`);
          lines.push(`- الدفعة الأولى: ${downVal} د.ك`);
          if(budgetVal) lines.push(`- القسط المرغوب: ${budgetVal} د.ك`);
          if(emiVal) lines.push(`- القسط التقديري: ${emiVal}`);
          if(totalVal) lines.push(`- الإجمالي التقديري: ${totalVal}`);
          if(interestVal) lines.push(`- إجمالي الفوائد: ${interestVal}`);
        }
        const message = lines.join('\n');

        try { await navigator.clipboard.writeText(message); } catch {}

        const url = whatsappURL(message);
        window.open(url, '_blank', 'noopener');

        toast.show();
        form.reset();
        form.classList.remove('was-validated');
        document.querySelectorAll('input[name="paymentMethod"]').forEach(r => r.checked = r.id === 'payCash');
        $('#bankSelect').value = "";
        $('#loanYears').value = "";
        $('#financeFields').style.display = 'none';
        modal.hide();
      });
    }

    function wireCTAs() {
      const waLink = `https://wa.me/${CONFIG.whatsappNumberE164}`;
      const msg = encodeURIComponent("مرحباً أحمد! مهتم بسيارات إم جي الجديدة من التوكيل الرسمي - مجموعة الغانم بالكويت.");
      ['ctaWhatsAppTop','ctaWhatsAppHero','ctaWhatsAppContact','fabWhatsApp'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.href = `${waLink}?text=${msg}`;
      });
      $('#ctaCall').href = `tel:${CONFIG.callNumber.replace(/\s+/g,'')}`;
      $('#ctaEmail').href = `mailto:aradwan@alghanimsons.com`;
      $('#salesName').textContent = 'Ahmed Abdelwahab';
      $('#footerName').textContent = 'Alghanim Sons Group | مجموعة الغانم وأولاده';
      $('#contactPhoto').src = CONFIG.contactPhoto;
      $('#mapEmbed').src = CONFIG.mapEmbedSrc;
      $('#year').textContent = new Date().getFullYear();
    }

    // Theme rotation
    function startThemeRotation(){
      try{
        const metaTheme = document.querySelector('meta[name="theme-color"]');
        let idx = 0;
        const apply = (t)=>{
          document.documentElement.style.setProperty('--wa', t.wa);
          document.documentElement.style.setProperty('--primary', t.primary || '#3b82f6');
          document.documentElement.style.setProperty('--dark', t.dark || '#0f172a');
          if(metaTheme) metaTheme.setAttribute('content', t.wa);
        };
        const list = CONFIG.themes || [];
        if(!list.length) return;
        apply(list[0]);
        setInterval(()=>{ idx = (idx+1)%list.length; apply(list[idx]); }, (CONFIG.themeRotateSeconds||12)*1000);
      }catch(e){ console.warn('Theme rotation failed', e); }
    }

    // Self-tests
    function runSelfTests(){
      try {
        const msg = ['Line1','Line2','Line3'].join('\n');
        console.assert(msg.includes('\n'), 'Message should include \\n');
        const encoded = encodeURIComponent(msg);
        console.assert(encoded.includes('%0A'), 'Encoded should include %0A');
        const url = `https://wa.me/201000000000?text=${encoded}`;
        console.assert(url.includes('%0A'), 'URL carries encoded newlines');
        const fab = document.getElementById('fabWhatsApp');
        console.assert(!!fab, 'FAB exists');
        // EMI sanity check (example: 10,000 KWD at 5% for 5 years)
        const P = 10000, annualRate = 0.05, years = 5;
        const monthlyRate = annualRate / 12;
        const months = years * 12;
        const expectedEMI = P * monthlyRate * Math.pow(1 + monthlyRate, months) / (Math.pow(1 + monthlyRate, months) - 1);
        // Expected EMI should be around 188.71 KWD
        console.assert(Math.abs(Math.round(expectedEMI) - 189) <= 5, `EMI calculation test: expected ~189, got ${Math.round(expectedEMI)}`);
        console.log('%cSelf-tests passed', 'color: green;');
      } catch (err) {
        console.error('Self-tests failed', err);
      }
    }

    // Mobile-specific optimizations
    function setupMobileOptimizations() {
      // Improve touch responsiveness
      document.addEventListener('touchstart', function() {}, { passive: true });
      
      // Prevent double-tap zoom on buttons
      const buttons = document.querySelectorAll('button, .btn, .car-card');
      buttons.forEach(btn => {
        btn.addEventListener('touchend', function(e) {
          e.preventDefault();
          this.click();
        }, { passive: false });
      });
      
      // Auto-hide address bar on mobile
      window.addEventListener('load', function() {
        setTimeout(function() {
          window.scrollTo(0, 1);
        }, 100);
      });
      
      // Improve form experience on mobile
      const inputs = document.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        input.addEventListener('focus', function() {
          // Scroll element into view on focus
          setTimeout(() => {
            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      });
      
      // Better modal experience on mobile
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        modal.addEventListener('shown.bs.modal', function() {
          document.body.style.position = 'fixed';
          document.body.style.width = '100%';
        });
        modal.addEventListener('hidden.bs.modal', function() {
          document.body.style.position = '';
          document.body.style.width = '';
        });
      });
    }

    // Init
    initFinanceOptions();
    renderCars(CARS);
    attachBuyButtons();
    setupSearchFilter();
    setupPaymentToggleV2();
    setupForm();
    wireCTAs();
    startThemeRotation();
    setupMobileOptimizations();
    runSelfTests();
  </script>
</body>
</html>